<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>CPU Opcode & ALU Control Designer</title>

    <style>
        body {
            background: #0b0b0b;
            color: #0ff;
            font-family: monospace;
            padding: 15px;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 10px;
        }

        input,
        button {
            background: #111;
            color: #0ff;
            border: 1px solid #333;
            padding: 6px;
            font-family: monospace;
        }

        button {
            cursor: pointer
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        td,
        th {
            border: 1px solid #333;
            text-align: center;
            padding: 4px;
        }

        th {
            background: #111
        }

        .toggle {
            cursor: pointer;
            user-select: none;
        }

        .zero {
            background: #000;
            color: #fff
        }

        .one {
            background: #fff;
            color: #000
        }

        .x {
            background: #222;
            color: #0ff
        }

        .readonly {
            background: #111;
            cursor: default;
        }

        /* ADDITION */
        .merged-selected {
            outline: 2px solid #0ff;
        }

        .scroll {
            max-height: 70vh;
            overflow: auto;
            border: 1px solid #333;
        }

        .cpu-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .cpu-item {
            border: 1px solid #333;
            padding: 4px 6px;
        }

        .cpu-item button {
            margin-left: 6px
        }

        input.text {
            width: 100%;
            border: none;
            background: #111;
            color: #0ff;
        }
    </style>
</head>

<body>

    <h2>CPU Opcode & Control Word Designer</h2>

    <div class="controls">
        <label>Opcode bits
            <div>
                <button onclick="changeOpcodeBits(-1)">÷2</button>
                <input id="opcodeBits" value="4" readonly>
                <button onclick="changeOpcodeBits(1)">×2</button>
            </div>
        </label>

        <label>Instruction count
            <input id="instructionCount" readonly>
        </label>

        <label>Register bits
            <input type="number" id="regBits" value="3" min="0">
        </label>
    </div>

    <h3>CPU Control Signals</h3>
    <div class="cpu-list" id="cpuList"></div>

    <div>
        <input id="newCpuName" placeholder="New signal name (e.g. CIN)">
        <button onclick="addCpuSignal()">Add CPU Signal</button>
    </div>

    <br>

    <div class="scroll">
        <table id="opcodeTable"></table>
    </div>

    <script>
        const STORAGE_KEY = "cpu_opcode_designer_state";

        const opcodeBitsInput = document.getElementById("opcodeBits");
        const instructionCount = document.getElementById("instructionCount");
        const regBits = document.getElementById("regBits");
        const opcodeTable = document.getElementById("opcodeTable");
        const cpuList = document.getElementById("cpuList");
        const newCpuName = document.getElementById("newCpuName");

        let opcodeBits = 4;
        let cpuSignals = ["EN", "!A", "!B", "CIN", "XOR", "OR", "FC", "PUSH", "POP", "CAL", "RET", "HLT"];
        let mergedCells = [];
        let undoStack = [];
        let cellState = {};

        let dragStartCol = null;
        let dragRow = null;

        /* ADDITION */
        let selectedMerge = null;

        function saveState() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify({
                opcodeBits,
                regBits: regBits.value,
                cpuSignals,
                mergedCells,
                cellState
            }));
        }

        function loadState() {
            const s = JSON.parse(localStorage.getItem(STORAGE_KEY) || "null");
            if (!s) return;
            opcodeBits = s.opcodeBits;
            opcodeBitsInput.value = opcodeBits;
            regBits.value = s.regBits;
            cpuSignals = s.cpuSignals;
            mergedCells = s.mergedCells;
            cellState = s.cellState || {};
        }

        function updateInstructionCount() {
            instructionCount.value = 1 << opcodeBits;
        }

        function changeOpcodeBits(d) {
            opcodeBits = Math.max(1, opcodeBits + d);
            opcodeBitsInput.value = opcodeBits;
            mergedCells = [];
            cellState = {};
            saveState();
            rebuild();
        }

        function triToggle(td, key) {
            td.dataset.state =
                td.dataset.state === "0" ? "1" :
                    td.dataset.state === "1" ? "X" : "0";
            updateToggle(td);
            cellState[key] = { state: td.dataset.state };
            saveState();
        }

        function updateToggle(td) {
            td.textContent = td.dataset.state;
            td.className = "toggle " +
                (td.dataset.state === "1" ? "one" :
                    td.dataset.state === "X" ? "x" : "zero");
        }

        function createToggle(row, col) {
            const td = document.createElement("td");
            const key = `${row}-${col}`;
            td.dataset.state = cellState[key]?.state || "0";
            updateToggle(td);

            td.onmousedown = e => {
                dragRow = row;
                dragStartCol = col;
                undoStack.push(JSON.stringify(mergedCells));
                e.preventDefault();
            };

            td.onclick = () => triToggle(td, key);
            return td;
        }

        document.addEventListener("mouseup", e => {
            if (dragStartCol === null) return;
            const td = e.target;
            if (!td.classList.contains("toggle")) return;

            const tr = td.parentNode;
            const endCol = [...tr.children].indexOf(td);
            if (endCol === dragStartCol) return;

            const regStart = opcodeBits;
            const regEnd = opcodeBits + +regBits.value - 1;
            const cpuStart = regEnd + 1;
            const cpuEnd = cpuStart + cpuSignals.length - 1;

            const sameSection =
                (dragStartCol >= regStart && endCol <= regEnd) ||
                (dragStartCol >= cpuStart && endCol <= cpuEnd);

            if (!sameSection) return;

            const start = Math.min(dragStartCol, endCol);
            const span = Math.abs(endCol - dragStartCol) + 1;

            if (mergedCells.some(m =>
                m.row === dragRow &&
                !(start + span <= m.startCol || start >= m.startCol + m.span)
            )) return;

            mergedCells.push({ row: dragRow, startCol: start, span });
            dragStartCol = null;
            saveState();
            rebuild();
        });

        /* ADDITION */
        document.addEventListener("keydown", e => {
            if ((e.key === "Delete" || e.key === "Backspace") && selectedMerge) {
                mergedCells = mergedCells.filter(m => m !== selectedMerge);
                selectedMerge = null;
                saveState();
                rebuild();
            }
        });

        function addCpuSignal() {
            const n = newCpuName.value.trim();
            if (!n || cpuSignals.includes(n)) return;
            cpuSignals.push(n);
            newCpuName.value = "";
            mergedCells = [];
            cellState = {};
            saveState();
            rebuild();
        }

        function buildCpuList() {
            cpuList.innerHTML = "";
            cpuSignals.forEach((s, i) => {
                const d = document.createElement("div");
                d.className = "cpu-item";
                d.textContent = s;
                const b = document.createElement("button");
                b.textContent = "✕";
                b.onclick = () => {
                    cpuSignals.splice(i, 1);
                    mergedCells = [];
                    cellState = {};
                    saveState();
                    rebuild();
                };
                d.appendChild(b);
                cpuList.appendChild(d);
            });
        }

        function rebuild() {
            buildCpuList();
            buildTable();
        }

        function buildTable() {
            opcodeTable.innerHTML = "";
            updateInstructionCount();

            const rows = 1 << opcodeBits;
            const tbody = document.createElement("tbody");

            for (let r = 0; r < rows; r++) {
                const tr = document.createElement("tr");
                const bin = r.toString(2).padStart(opcodeBits, "0");

                for (const b of bin) {
                    const td = document.createElement("td");
                    td.textContent = b;
                    td.className = "readonly";
                    tr.appendChild(td);
                }

                let col = opcodeBits;
                for (let i = 0; i < regBits.value; i++, col++)
                    tr.appendChild(createToggle(r, col));
                cpuSignals.forEach(() => tr.appendChild(createToggle(r, col++)));

                for (let i = 0; i < 3; i++) {
                    const td = document.createElement("td");
                    const inp = document.createElement("input");
                    const key = `${r}-text-${i}`;
                    inp.className = "text";
                    inp.value = cellState[key]?.text || "";
                    inp.oninput = () => {
                        cellState[key] = { text: inp.value };
                        saveState();
                    };
                    td.appendChild(inp);
                    tr.appendChild(td);
                }

                mergedCells.filter(m => m.row === r).forEach(m => {
                    const cell = tr.children[m.startCol];
                    cell.colSpan = m.span;

                    /* ADDITION */
                    cell.onclick = () => {
                        document.querySelectorAll(".merged-selected")
                            .forEach(c => c.classList.remove("merged-selected"));
                        cell.classList.add("merged-selected");
                        selectedMerge = m;
                    };

                    for (let i = 1; i < m.span; i++)
                        tr.removeChild(tr.children[m.startCol + 1]);
                });

                tbody.appendChild(tr);
            }

            opcodeTable.appendChild(tbody);
        }

        loadState();
        rebuild();
    </script>
</body>

</html>
